apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-primary-config
  namespace: keycloak
  labels:
    app.kubernetes.io/component: postgres-primary
data:
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 100

    # Memory Settings (tuned for ~512Mi container limit)
    shared_buffers = 128MB
    effective_cache_size = 384MB
    work_mem = 4MB
    maintenance_work_mem = 64MB

    # WAL Settings (critical - enables replication from day one)
    wal_level = replica              # Minimum for streaming replication
    max_wal_senders = 3             # Primary can serve up to 3 replicas
    wal_keep_size = 64              # Keep 64MB of WAL segments
    max_replication_slots = 3       # Replication slots for reliability

    # Checkpoint Settings
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB

    # Logging (verbose for learning)
    log_destination = 'stderr'
    logging_collector = off
    log_connections = on
    log_disconnections = on
    log_duration = off
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_statement = 'ddl'           # Log schema changes, not every query
    log_min_duration_statement = 1000  # Log queries > 1 second

    # Replication standby settings (ignored on primary, needed when promoted)
    hot_standby = on

  pg_hba.conf: |
    # Host based Authentication
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # Local connections (within pod)
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            trust
    host    all             all             ::1/128                 trust

    # Application connections from cluster pods
    host    all             all             10.244.0.0/16           scram-sha-256

    # Replication connections - replicator user only
    host    replication     replicator      10.244.0.0/16           scram-sha-256

  init-db.sh: |
    #!/bin/bash
    set -e

    echo "=== PostgreSQL Init Script Starting ==="

    # Create replication user (POSTGRES_USER already created by entrypoint)
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Create replication user for streaming replication
        CREATE USER ${REPLICATION_USER} WITH REPLICATION LOGIN ENCRYPTED PASSWORD '${REPLICATION_PASSWORD}';

        -- Grant connect on keycloak DB to app user (already owner, but explicit)
        GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_DB} TO ${POSTGRES_USER};

        -- Log what we created
        \echo 'Created replication user: ${REPLICATION_USER}'
        \echo 'Database ready: ${POSTGRES_DB}'
    EOSQL

    echo "=== PostgreSQL Init Script Complete ==="